<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
        <title>FACE Website</title>
        <script type="text/javascript" src="http://www.google.com/jsapi">
        </script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false">
        </script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/dojo/1.6/dojo/dojo.xd.js" djConfig="parseOnLoad: true">
        </script>
        <link rel="stylesheet" type="text/css" href="http://code.google.com/apis/maps/documentation/javascript/examples/default.css"/>
        <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/dojo/1.6/dijit/themes/claro/claro.css"/>
        <link rel="stylesheet" type="text/css" href="styles/styles.css">
        <script type="text/javascript">
            dojo.require("dojo.data.ItemFileReadStore");
            dojo.require("dijit.form.ComboBox");
            dojo.require("dojo.io.script");
            dojo.addOnLoad(onLoad);
            var map, layer;
            function onLoad(){
                var centre = new google.maps.LatLng(50, 10);
                map = new google.maps.Map(document.getElementById('map_canvas'), {
                    center: centre,
                    zoom: 4,
                    mapTypeId: 'terrain'
                });
                dojo.io.script.get({
                    url: "http://www.google.com/fusiontables/api/query?sql=select%20ID,Scientific,English%20from%201009501%20order%20by%20Scientific&jsonCallback=done"
                });
            }
            
            function done(results){
                var rows = results.table.rows;
                var items = [];
                dojo.forEach(rows, function(row, i){
                    items.push({
                        Scientific: row[1] + " (" + row[2] + ")",
                        ID: row[0]
                    });
                });
                speciesStore.data = {
                    identifier: "ID",
                    label: "Scientific",
                    items: items
                };
            }
            
            function changeSpecies(){
                var comboBox = dojo.byId("speciesList");
                var position = comboBox.value.indexOf("(");
                var scientific = comboBox.value.substring(0,position-1);
                var options = {
                    query: {
                        select: 'geometry',
                        from: '1009188',
                        where: "Scientific='" + scientific + "'"
                    }
                };
                if (layer) {
                  layer.setOptions(options);
                }
                else {
                    layer = new google.maps.FusionTablesLayer(options);
                    layer.setMap(map);
                }
            }
        </script>
    </head>
    <body class="tundra">
        <div dojoType="dojo.data.ItemFileReadStore" jsId="speciesStore">
        </div>
        <div dojoType="dijit.form.ComboBox" store="speciesStore" searchAttr="Scientific" id="speciesList" onChange="changeSpecies(event)">
        </div>
        <div id="map_canvas">
        </div>
    </body>
</html>
